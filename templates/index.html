<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›¹ í¬ë¡¤ëŸ¬ ë° ì‹œê°í™” ë„êµ¬</title>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; line-height: 1.6; background-color: #f4f4f4; color: #333; }
        .tab-container { width: 100%; }
        .tab-buttons { overflow: hidden; border-bottom: 1px solid #ccc; background-color: #f1f1f1; }
        .tab-buttons button { background-color: inherit; float: left; border: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; font-size: 17px; }
        .tab-buttons button:hover { background-color: #ddd; }
        .tab-buttons button.active { background-color: #ccc; }
        .tab-content { display: none; padding: 20px; border-top: none; background-color: #fff; min-height: 400px;}
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom:20px; }
        h1, h2, h3 { color: #333; text-align: center; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="url"], select {
            width: calc(100% - 24px); padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;
        }
        button {
            background-color: #5cb85c; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;
        }
        button:hover { background-color: #4cae4c; }
        #resultsArea, #visualizationControls { margin-top: 20px; padding: 10px; border: 1px solid #eee; border-radius: 4px; background-color: #f9f9f9; }
        #resultsArea ul { list-style-type: none; padding-left: 0; }
        #resultsArea li { background-color: #fff; border: 1px solid #ddd; padding: 8px; margin-bottom: 5px; border-radius: 4px; }
        .message { padding: 10px; margin-bottom: 15px; border-radius: 4px; }
        .success { background-color: #dff0d8; color: #3c763d; border: 1px solid #d6e9c6; }
        .error { background-color: #f2dede; color: #a94442; border: 1px solid #ebccd1; }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; margin-left: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #chartDiv { width: 100%; min-height: 450px; margin-top:20px; border: 1px solid #ddd; border-radius: 4px;}
        .control-group { margin-bottom: 15px; }
    </style>
</head>
<body>
    <h1>ì›¹ í¬ë¡¤ëŸ¬ ë° ì‹œê°í™” ë„êµ¬ ğŸ•¸ï¸ğŸ“Š</h1>

    <div class="tab-container">
        <div class="tab-buttons">
            <button class="tab-link active" onclick="openTab(event, 'crawlerTab')">ì›¹ í¬ë¡¤ëŸ¬</button>
            <button class="tab-link" onclick="openTab(event, 'visualizationTab')">ë°ì´í„° ì‹œê°í™”</button>
        </div>

        <div id="crawlerTab" class="tab-content" style="display: block;">
            <h2>ë°ì´í„° ìˆ˜ì§‘</h2>
            <div class="container">
                <div id="crawlerMessageArea"></div>  <div>
                    <label for="urlInput">ì›¹ì‚¬ì´íŠ¸ URL:</label>
                    <input type="url" id="urlInput" placeholder="ì˜ˆ: https://www.example.com">
                </div>
                <div>
                    <label for="tagInput">ì¶”ì¶œí•  HTML íƒœê·¸ ë˜ëŠ” CSS ì„ íƒì:</label>
                    <input type="text" id="tagInput" placeholder="ì˜ˆ: h2, p, div.content, #main-title, a">
                </div>
                <button onclick="startCrawl()">í¬ë¡¤ë§ ì‹œì‘</button>
                <div class="spinner" id="crawlLoadingSpinner"></div>
                <div id="resultsArea" style="display:none;">
                    <h3>í¬ë¡¤ë§ ê²°ê³¼ (ì¼ë¶€):</h3>
                    <p id="filePathMessage"></p>
                    <ul id="resultsList"></ul>
                </div>
            </div>
        </div>

        <div id="visualizationTab" class="tab-content">
            <h2>ë°ì´í„° ì‹œê°í™”</h2>
            <div class="container">
                <div id="vizMessageArea"></div> <div id="visualizationControls">
                    <div class="control-group">
                        <label for="csvFileSelect">ë¶„ì„í•  CSV íŒŒì¼ ì„ íƒ:</label>
                        <select id="csvFileSelect"></select>
                    </div>
                    <div class="control-group">
                        <label for="analysisTypeSelect">ë¶„ì„ ìœ í˜• ì„ íƒ:</label>
                        <select id="analysisTypeSelect">
                            <option value="keyword_frequency">í‚¤ì›Œë“œ ë¹ˆë„ ë¶„ì„</option>
                            </select>
                    </div>
                    <div id="keywordAnalysisOptions" class="control-group">
                        <label for="keywordsInput">í‚¤ì›Œë“œ ì…ë ¥ (ì‰¼í‘œë¡œ êµ¬ë¶„):</label>
                        <input type="text" id="keywordsInput" placeholder="ì˜ˆ: ë°ì´í„°, ë¶„ì„, ì‹œê°í™”">
                    </div>
                    <div class="control-group">
                        <label for="chartTypeSelect">ì°¨íŠ¸ ì¢…ë¥˜ ì„ íƒ:</label>
                        <select id="chartTypeSelect">
                            <option value="bar">ë§‰ëŒ€ ê·¸ë˜í”„</option>
                            <option value="line">ì„  ê·¸ë˜í”„</option>
                            </select>
                    </div>
                    <button onclick="generateVisualization()">ì‹œê°í™” ìƒì„±</button>
                    <div class="spinner" id="vizLoadingSpinner"></div>
                </div>
                <div id="chartDiv">
                    <p style="text-align:center; padding-top: 50px;">ì°¨íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Tab ê¸°ëŠ¥ ---
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";

            if (tabName === 'visualizationTab') {
                loadCsvFiles(); // ì‹œê°í™” íƒ­ì„ ì—´ ë•Œ CSV íŒŒì¼ ëª©ë¡ ë¡œë“œ
            }
        }

        // --- ì¼ë°˜ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜ (ìˆ˜ì •ë¨) ---
        function showMessage(message, type, areaId) {
            const messageArea = document.getElementById(areaId);
            if (messageArea) { // messageArea ìš”ì†Œë¥¼ ì°¾ì•˜ëŠ”ì§€ í™•ì¸
                if (message) {
                    messageArea.innerHTML = `<div class="message ${type}">${message}</div>`;
                } else {
                    messageArea.innerHTML = ''; // ë©”ì‹œì§€ ë‚´ìš©ì´ ì—†ìœ¼ë©´ ì˜ì—­ì„ ë¹„ì›€
                }
            } else {
                console.error("showMessage: Message area ID '" + areaId + "' not found in HTML.");
            }
        }

        // --- í¬ë¡¤ëŸ¬ ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸ ---
        async function startCrawl() {
            const url = document.getElementById('urlInput').value;
            const elementTag = document.getElementById('tagInput').value;
            const resultsArea = document.getElementById('resultsArea');
            const resultsList = document.getElementById('resultsList');
            const filePathMessage = document.getElementById('filePathMessage');
            const loadingSpinner = document.getElementById('crawlLoadingSpinner');

            resultsArea.style.display = 'none';
            resultsList.innerHTML = '';
            filePathMessage.textContent = '';
            showMessage('', undefined, 'crawlerMessageArea'); // ë©”ì‹œì§€ ì´ˆê¸°í™”, typeì„ undefinedë¡œ ì „ë‹¬ ê°€ëŠ¥
            loadingSpinner.style.display = 'inline-block';

            if (!url || !elementTag) {
                showMessage('URLê³¼ ì¶”ì¶œí•  HTML íƒœê·¸(ë˜ëŠ” CSS ì„ íƒì)ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error', 'crawlerMessageArea');
                loadingSpinner.style.display = 'none';
                return;
            }

            try {
                const response = await fetch('/crawl', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url, element_tag: elementTag }),
                });
                const result = await response.json();
                loadingSpinner.style.display = 'none';

                if (response.ok) {
                    showMessage(result.message || 'í¬ë¡¤ë§ ì™„ë£Œ!', 'success', 'crawlerMessageArea');
                    if (result.data && result.data.length > 0) {
                        resultsArea.style.display = 'block';
                        result.data.forEach(item => {
                            const li = document.createElement('li');
                            let itemText = item.text;
                            if (item.link) itemText += ` (ë§í¬: ${item.link})`;
                            li.textContent = itemText;
                            resultsList.appendChild(li);
                        });
                        if(result.filepath) filePathMessage.textContent = `ì „ì²´ ë°ì´í„°ëŠ” ì„œë²„ì˜ ë‹¤ìŒ ê²½ë¡œì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤: ${result.filepath}`;
                    } else if (!result.error) {
                         filePathMessage.textContent = result.message || "ì¶”ì¶œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
                         resultsArea.style.display = 'block';
                    }
                } else {
                    showMessage(result.error || 'í¬ë¡¤ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error', 'crawlerMessageArea');
                }
            } catch (error) {
                loadingSpinner.style.display = 'none';
                showMessage('ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.toString(), 'error', 'crawlerMessageArea');
            }
        }

        // --- ì‹œê°í™” ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸ ---
        async function loadCsvFiles() {
            const csvFileSelect = document.getElementById('csvFileSelect');
            try {
                const response = await fetch('/api/csv_files');
                const result = await response.json();
                if (response.ok && result.csv_files) {
                    csvFileSelect.innerHTML = '<option value="">-- CSV íŒŒì¼ ì„ íƒ --</option>'; 
                    result.csv_files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file;
                        option.textContent = file;
                        csvFileSelect.appendChild(option);
                    });
                } else {
                    showMessage(result.error || 'CSV íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error', 'vizMessageArea');
                }
            } catch (error) {
                showMessage('CSV íŒŒì¼ ëª©ë¡ ë¡œë”© ì¤‘ ì˜¤ë¥˜: ' + error.toString(), 'error', 'vizMessageArea');
            }
        }

        async function generateVisualization() {
            const csvFile = document.getElementById('csvFileSelect').value;
            const analysisType = document.getElementById('analysisTypeSelect').value;
            const keywords = document.getElementById('keywordsInput').value;
            const chartType = document.getElementById('chartTypeSelect').value;
            const chartDiv = document.getElementById('chartDiv');
            const loadingSpinner = document.getElementById('vizLoadingSpinner');

            showMessage('', undefined, 'vizMessageArea'); 
            chartDiv.innerHTML = '<p style="text-align:center; padding-top: 50px;">ì°¨íŠ¸ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</p>';
            loadingSpinner.style.display = 'inline-block';

            if (!csvFile) {
                showMessage('ë¶„ì„í•  CSV íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error', 'vizMessageArea');
                loadingSpinner.style.display = 'none';
                chartDiv.innerHTML = '<p style="text-align:center; padding-top: 50px;">ì°¨íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>';
                return;
            }

            let payload = {
                filename: csvFile,
                analysis_type: analysisType,
            };

            if (analysisType === 'keyword_frequency') {
                if (!keywords) {
                    showMessage('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error', 'vizMessageArea');
                    loadingSpinner.style.display = 'none';
                    chartDiv.innerHTML = '<p style="text-align:center; padding-top: 50px;">ì°¨íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>';
                    return;
                }
                payload.keywords = keywords;
            }

            try {
                const response = await fetch('/api/visualize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                loadingSpinner.style.display = 'none';

                if (response.ok) {
                    if (result.x_values && result.y_values) {
                        const plotData = [{
                            x: result.x_values,
                            y: result.y_values,
                            type: chartType
                        }];
                        const layout = {
                            title: result.title || 'ë°ì´í„° ì‹œê°í™”',
                            xaxis: { title: (analysisType === 'keyword_frequency' ? 'í‚¤ì›Œë“œ' : 'Xì¶•') },
                            yaxis: { title: (analysisType === 'keyword_frequency' ? 'ë¹ˆë„ìˆ˜' : 'Yì¶•') },
                            margin: { t: 50, b: 100, l:50, r:50 }
                        };
                        Plotly.newPlot('chartDiv', plotData, layout, {responsive: true});
                        showMessage('ì°¨íŠ¸ ìƒì„± ì™„ë£Œ!', 'success', 'vizMessageArea');
                    } else {
                         showMessage(result.message || 'ì‹œê°í™”í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error', 'vizMessageArea');
                         chartDiv.innerHTML = '<p style="text-align:center; padding-top: 50px;">ì‹œê°í™”í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    }
                } else {
                    showMessage(result.error || 'ì‹œê°í™” ë°ì´í„° ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ.', 'error', 'vizMessageArea');
                    chartDiv.innerHTML = `<p style="text-align:center; padding-top: 50px;">ì˜¤ë¥˜: ${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>`;
                }
            } catch (error) {
                loadingSpinner.style.display = 'none';
                showMessage('ì‹œê°í™” ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.toString(), 'error', 'vizMessageArea');
                chartDiv.innerHTML = `<p style="text-align:center; padding-top: 50px;">ìš”ì²­ ì˜¤ë¥˜: ${error.toString()}</p>`;
            }
        }
        
        // ì´ˆê¸° íƒ­ ì„¤ì • (ì²« ë²ˆì§¸ íƒ­ í™œì„±í™”)
        document.addEventListener("DOMContentLoaded", function() {
            // ê¸°ë³¸ì ìœ¼ë¡œ ì²« ë²ˆì§¸ íƒ­ ë²„íŠ¼ì„ í´ë¦­í•œ ê²ƒì²˜ëŸ¼ ì²˜ë¦¬
            // í•˜ì§€ë§Œ active í´ë˜ìŠ¤ëŠ” CSSì—ì„œ ì´ë¯¸ ì²« ë²ˆì§¸ ë²„íŠ¼ì— ì ìš©í–ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ,
            // ì—¬ê¸°ì„œëŠ” openTab í•¨ìˆ˜ë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ì—¬ ë‚´ìš©ë§Œ ë³´ì´ë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ë˜ëŠ”, ì²« ë²ˆì§¸ ë²„íŠ¼ì— active í´ë˜ìŠ¤ê°€ ì´ë¯¸ ìˆë‹¤ë©´, í•´ë‹¹ IDì˜ íƒ­ ë‚´ìš©ë§Œ ë³´ì´ê²Œ í•©ë‹ˆë‹¤.
            if(document.getElementsByClassName("tab-link")[0]){
                 document.getElementsByClassName("tab-link")[0].click();
            }
        });

    </script>
</body>
</html>